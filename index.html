<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Game with XP</title>
<style>
  /* Basic styles for the game */
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  #startScreen {
    margin-bottom: 20px;
  }
  #question {
    font-size: 1.4em;
    margin-bottom: 10px;
  }
  #feedback {
    margin-top: 10px;
    min-height: 3em;
  }
  #nextBtn {
    margin-top: 10px;
  }
  #xpContainer {
    position: relative;
    width: 200px;
    height: 24px;
    border: 1px solid #333;
    background: #ddd;
    margin-top: 8px;
    border-radius: 4px;
    overflow: hidden;
  }
  #xpProgress {
    height: 100%;
    background: linear-gradient(90deg, #6a0dad, #9b59b6);
    width: 0%;
    transition: width 0.5s ease;
  }
  #xpMultiplierAnim {
    position: absolute;
    right: 10px;
    top: -30px;
    color: #ff0;
    font-weight: bold;
    font-size: 16px;
    opacity: 0;
    pointer-events: none;
    user-select: none;
    text-shadow: 1px 1px 2px #000;
  }
  @keyframes floatUpFade {
    0% {
      opacity: 1;
      transform: translateY(0);
    }
    100% {
      opacity: 0;
      transform: translateY(-30px);
    }
  }
</style>
</head>
<body>

<div id="startScreen">
  <button id="startBtn">„Çπ„Çø„Éº„Éà</button>
</div>

<div id="gameArea" style="display:none;">
  <div id="question">Press Start</div>
  <input type="text" id="answerInput" autocomplete="off" />
  <button id="nextBtn" style="display:none;">Next</button>
  <div id="feedback"></div>

  <div>
    <span id="score">Score: 0</span> |
    <span id="streak">„Ç≥„É≥„Éú: 0</span> |
    <span id="xp">XP: 0</span> |
    <span id="level">Lv: 1</span>
  </div>

  <div id="xpContainer">
    <div id="xpProgress"></div>
    <div id="xpMultiplierAnim"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
let questions = [];
let currentQuestion = null;
let score = 0;
let streak = 0;
let xp = 0;
let level = 1;
let userInteracted = false;

// Start screen elements
const startScreen = document.getElementById("startScreen");
const startBtn = document.getElementById("startBtn");

// DOM elements
const gameArea = document.getElementById("gameArea");
const questionDisplay = document.getElementById("question");
const answerInput = document.getElementById("answerInput");
const feedback = document.getElementById("feedback");
const nextBtn = document.getElementById("nextBtn");
const scoreDisplay = document.getElementById("score");
const streakDisplay = document.getElementById("streak");
const xpDisplay = document.getElementById("xp");
const levelDisplay = document.getElementById("level");

// New DOM elements for XP progress bar and multiplier animation
const xpProgress = document.getElementById("xpProgress");
const xpMultiplierAnim = document.getElementById("xpMultiplierAnim");

// Start the game on button click
startBtn.addEventListener("click", () => {
  userInteracted = true;
  startScreen.style.display = "none";
  gameArea.style.display = "block";
  showQuestion();
});

// Load CSV with PapaParse
Papa.parse("questions.csv", {
  download: true,
  header: true,
  complete: function(results) {
    questions = results.data.filter(q => q.jp && q.en);
  }
});

function getRandomQuestion() {
  return questions[Math.floor(Math.random() * questions.length)];
}

function speak(text) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "en-US";
  speechSynthesis.speak(utterance);
}

function showQuestion() {
  currentQuestion = getRandomQuestion();
  questionDisplay.textContent = `${currentQuestion.en} ${currentQuestion.jp}`;
  answerInput.value = "";
  answerInput.disabled = false;
  feedback.innerHTML = "";
  nextBtn.style.display = "none";
  answerInput.focus();

  if (userInteracted && currentQuestion.en) {
    speak(currentQuestion.en);
  }
}

function updateScoreAndStreakDisplay() {
  scoreDisplay.textContent = "Score: " + score;
  streakDisplay.textContent = "„Ç≥„É≥„Éú: " + streak;
}

function updateXPDisplay() {
  if (xpDisplay) xpDisplay.textContent = "XP: " + xp;
  if (levelDisplay) levelDisplay.textContent = "Lv: " + level;

  const baseXP = 1;
  const xpNeeded = (level ** 2) * baseXP;
  const progressPercent = Math.min((xp / xpNeeded) * 100, 100);
  if (xpProgress) {
    xpProgress.style.width = progressPercent + "%";
  }
}

function saveProgress() {
  localStorage.setItem("events_xp", xp);
  localStorage.setItem("events_level", level);
}

function loadProgress() {
  const savedXP = localStorage.getItem("events_xp");
  const savedLevel = localStorage.getItem("events_level");
  if (savedXP !== null) xp = parseInt(savedXP, 10);
  if (savedLevel !== null) level = parseInt(savedLevel, 10);
  updateScoreAndStreakDisplay();
  updateXPDisplay();
}

function checkLevelUp() {
  const baseXP = 1;
  const xpNeeded = (level ** 2) * baseXP;

  if (xp >= xpNeeded) {
    level++;
    xp -= xpNeeded;
    feedback.innerHTML += `<br/>üéâ „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅNow Level ${level}`;
    saveProgress();
    updateXPDisplay();
  }
}

function showXpMultiplierAnimation(multiplier) {
  xpMultiplierAnim.textContent = `+${multiplier}x XP!`;
  xpMultiplierAnim.style.opacity = "1";
  xpMultiplierAnim.style.animation = "floatUpFade 1.5s forwards";

  xpMultiplierAnim.addEventListener("animationend", () => {
    xpMultiplierAnim.style.opacity = "0";
    xpMultiplierAnim.style.animation = "";
  }, { once: true });
}

function showFeedback(correct, expected, userInput) {
  if (correct) {
    streak++;
    score++;

    const xpMultiplier = 1 + Math.floor(streak / 15);
    const xpGained = xpMultiplier;

    xp += xpGained;

    feedback.innerHTML = `‚úÖ Ê≠£Ëß£ÔºÅGood job!<br/>XP +${xpGained}`;

    if (xpMultiplier > 1) {
      showXpMultiplierAnimation(xpMultiplier);
    }

    checkLevelUp();
    saveProgress();
    updateScoreAndStreakDisplay();
    updateXPDisplay();
  } else {
    let mismatchIndex = [...expected].findIndex((char, i) => char !== userInput[i]);
    if (mismatchIndex === -1 && userInput.length > expected.length) {
      mismatchIndex = expected.length;
    }

    const correctPart = expected.slice(0, mismatchIndex);
    const wrongPart = expected.slice(mismatchIndex);

    feedback.innerHTML = `
      ‚ùå ÈñìÈÅï„ÅÑ„Åå„ÅÇ„Çä„Åæ„Åô<br/>
      <strong>Ê≠£Ëß£:</strong> ${expected}<br/>
      <strong>„ÅÇ„Å™„Åü„ÅÆÁ≠î„Åà:</strong> ${userInput}<br/>
      <strong>„Åì„Åì„ÅåÈñìÈÅï„ÅÑ:</strong> ${correctPart}<span style="color:red">${wrongPart}</span>
    `;
    streak = 0;
    updateScoreAndStreakDisplay();
  }

  answerInput.disabled = true;
  nextBtn.style.display = "inline-block";
}

answerInput.addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    if (answerInput.disabled) {
      showQuestion();
    } else {
      const userAnswer = answerInput.value.trim();
      const expected = currentQuestion.en.trim();
      const isCorrect = userAnswer === expected;
      showFeedback(isCorrect, expected, userAnswer);
    }
  }
});

nextBtn.addEventListener("click", showQuestion);

loadProgress();
</script>
</body>
</html>
